# 3UTR Quantification

## Summary
1. Processing of 3'UTR Annotations to remove overlaps 

Overlapping 3'UTR annotation are resolved, according to the increasing order of importance of: Ensembl, RefSeq, and De-Novo. 
The output file contains the last 300bp from the 3'end of each 3'UTR isoforms. 

2. Quantificiation of reads mapped to 3'end of each 3'UTR isoforms

The annotation from the previous set is used by featureCounts to quantify reads that fall within these 300bp regions. 

3. Identification of expressed genes. 

Kallisto is used to quantify gene expression.
Expressed genes are retained on the intra-sample level based on fitting a 2 component GMM, and excluding those within a specified percentile (default: 0.85) of the background distribution. 
Expressed genes are than retained on the inter-sample according to how frequently it is expressed within each treatment groups (Default: 0.5).  

4. Relative usage of 3'UTR isoforms: PUD/RUD calculation

Relative usage of the proximal isoform is than calculated for all pairs of 3'UTR isoforms within expressed genes. 

PUD: (Proximal) / (Proximal + Distal) 

RUD: log2(Proximal/Distal)

Given that distal isoforms always overlap with proximal isoforms, the output contains read counts that are corrected for this. 

## Dependencies
### Conda and Snakemake 
Conda is required to run Snakemake. 
For Linux systems, this installer can be used: [Miniconda3-latest-Linux-x86_64.sh](https://docs.conda.io/projects/conda/en/latest/user-guide/install/linux.html)

Download the installer and run:

```
bash Miniconda3-latest-Linux-x86_64.sh
```

After installing conda, install mamba which is required for snakemake

```
conda install -n base -c conda-forge mamba
```

Then install snakemake and singularity

```
conda activate base
mamba create -c conda-forge -c bioconda -n snakemake snakemake
```

### Other Software and Data Dependencies
All other dependencies are listed in yml files found in [./envs/](../envs/). These are automatically installed when the pipeline is invoked using Snakemake
Alternatively, conda enviroments can be created by manually installing the python projects:  

```
conda create -n apatools python=3.21 r-base
conda activate apatools
pip install ./envs/apatools
pip install ./envs/bulkanalysis
pip install ./envs/genomemanger
pip install ./envs/kallistomanger
conda deactivate
```
The required enseml/refseq annotation files for human (GRCh38) are stored on Zenodo ([https://doi.org/10.5281/zenodo.17202125](https://doi.org/10.5281/zenodo.17202125)) and can be placed in the [./workflow/data/)](./workflow/data/) directory. 
For other species, please create the relevant annotation files. 

## Input

Path to input files are specified in the [config.yml](./config/config.yml) file.

### BAM Files (bam_dir)
Path to directory that contains bam files. The defauly suffix is ".Aligned.sortedByCoord.out.bam", which is produced by STAR. This should be modified if needed. 

### 3'UTR Annotation File
Path to the 3'UTR annotation gtf file 
For example, the [hg38_Denovo_Ensembl_RefSeq_Filt_Reformat.gtf](hg38_Denovo_Ensembl_RefSeq_Filt_Reformat.gtf) file generated by [3UTR_Annot](https://gitlab.idiap.ch/genomics/genomics/toolboxes/3utr_annot) pipeline could be used. 

### Treatment Group specification and other parameters
[genes_preprocessing_template.yaml](./config/genes_preprocessing_template.yaml) and [bulkapa_template.yaml](./config/bulkapa_template.yaml) should be modified

"treatments" should be defined as:

Group_1:\
&nbsp;&nbsp;&nbsp;&nbsp;sample_1 \
&nbsp;&nbsp;&nbsp;&nbsp;sample_2

Group_2:   
&nbsp;&nbsp;&nbsp;&nbsp;sample_1\
&nbsp;&nbsp;&nbsp;&nbsp;sample_2\
&nbsp;&nbsp;&nbsp;&nbsp;sample_3    


"pct_in_treatment" can be adjusted to specify the criteria for a gene/3'UTR isoform to be considered as expressed.  

### Output Directory
Path to output directory. 


## Running the Pipeline

By default, the entire pipeline is run and the final annotation file will be stored in the specified output directory. 
To run only certain rules, change the "Input" rule in the [Snakefile](./workflow/Snakefile)

First, set the correct directory and activate the environment:

```
cd ./workflow
conda activate snakemake
```

To check the rules that'll be invoked based on the output:

```
snakemake --dry-run
```
To run the pipeline: 
```
snakemake --use-conda --rerun-trigger mtime
```

### HPC(SLURM)
The pipeline can be invoked to run in HPC enviroments (SLURM) using the following scripts
Option 1: 
```
sbatch run_Snakemake.sh
```
The number of concurrent jobs (ie samples processed) should be specified under --jobs within the script, along with the number of CPU cores. 

Option 2: 
```
./run_Snakemake_SLURM.sh
```
The number of concurrent jobs (ie samples processed) should be specified under --jobs within the script. 
Other specifications for SLURM (e.g. number of cores, memory, runtime) can be specified by modifying [../config/config.yaml](../config/config.yaml)

## Output

[table_of_pairs_simplified.csv](table_of_pairs_simplified.csv):  For each promoter-distal 3'UTR isoform, its relative expression compared to the proximal (PUD and RUD) and its corrected expression level. 

Description of column names\
**proximal_id**: ID of most promoter-proximal 3'UTR isoform \
**distal_id**: ID of the promoter-distal 3'UTR isoform \
***_prox**: Corrected expression level of the proximal isoform (In a sample or condition) \
***_dist**: Corrected expression level of the distal isoform  (In a sample or condition) \
***_PUD**: (Proximal) / (Proximal + Distal),  (In a sample or condition) \
***_RUD**: log2(Proximal/Distal), (In a sample or condition)

[table_of_pairs.csv](table_of_pairs.csv): Same as table_of_pairs_simplified.csv, except it also contains Fisher's test results for the difference in relative-usage between conditions. 

Description of column names\
**fisher_table_***: 2 by 2 contigency table of with expression levels of proximal and distal isoform across two conditions.\
**fisher_pvalue_***: p-value based on Fisher's exact test. 

[message.log](message.log): Statistics, including the number of expressed genes/3'UTR isoforms included. 


